<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Upload t√†i li·ªáu ‚Äî FP-term-3</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/upload.css" />
  </head>
  <body>
    <!-- header gi·ªëng index ƒë·ªÉ ƒë·ªìng b·ªô -->
    <header class="top-header">
      <div class="header-left">
        <img src="/images/bookshelf.jpg" alt="Bookshelf" class="bookshelf logo" />
      </div>

      <nav class="menu-class" aria-label="Menu l·ªõp">
        <a href="#" data-class="L·ªõp 6">L·ªõp 6</a>
        <a href="#" data-class="L·ªõp 7">L·ªõp 7</a>
        <a href="#" data-class="L·ªõp 8">L·ªõp 8</a>
        <a href="#" data-class="L·ªõp 9">L·ªõp 9</a>
        <a href="#" data-class="L·ªõp 10">L·ªõp 10</a>
        <a href="#" data-class="L·ªõp 11">L·ªõp 11</a>
        <a href="#" data-class="L·ªõp 12">L·ªõp 12</a>
        <a href="#" data-class="Gi√°o √°n - ƒê·ªÅ thi">Gi√°o √°n - ƒê·ªÅ thi</a>
      </nav>

      <div class="header-right">
        <form class="search-form" id="searchFormTop">
          <input class="search-input" name="q" type="search" placeholder="T√¨m ki·∫øm..." aria-label="T√¨m" />
          <button class="search-btn" type="submit">üîç</button>
        </form>
      </div>
    </header>

    <main class="upload-main container">
      <section class="upload-hero">
        <h1>Upload t√†i li·ªáu</h1>
        <p class="lead">K√©o th·∫£ ho·∫∑c ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i ƒë·∫øn server. (CSV / JSON / XLSX / ·∫¢nh ...)</p>
      </section>

      <div id="dropzone" class="dropzone" tabindex="0" aria-label="K√©o th·∫£ t·ªáp v√†o ƒë√¢y">
        <input id="fileInput" type="file" multiple />
        <div class="drop-inner">
          <strong>K√©o th·∫£ t·ªáp ·ªü ƒë√¢y</strong>
          <div class="small">Ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn file</div>
        </div>
      </div>

      <div class="controls">
        <button id="uploadBtn" class="btn" disabled>Upload t·∫•t c·∫£</button>
        <button id="clearBtn" class="btn btn-ghost" disabled>X√≥a t·∫•t c·∫£</button>
      </div>

      <section id="fileList" class="file-list">
        <div class="muted">Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn</div>
      </section>

      <div id="serverResponse" class="server-response" aria-live="polite"></div>
    </main>

    <footer class="site-footer">
      <div class="container">¬© FP-term-3</div>
    </footer>

    <script>
      // upload UI (client-side), POST ‚Üí /api/upload
      (function () {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const fileListEl = document.getElementById('fileList');
        const serverResponse = document.getElementById('serverResponse');

        let files = [];

        function renderList() {
          fileListEl.innerHTML = '';
          if (files.length === 0) {
            fileListEl.innerHTML = '<div class="muted">Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn</div>';
            uploadBtn.disabled = true;
            clearBtn.disabled = true;
            return;
          }
          uploadBtn.disabled = false;
          clearBtn.disabled = false;

          files.forEach((it, idx) => {
            const row = document.createElement('div');
            row.className = 'file-row';

            const left = document.createElement('div');
            left.className = 'file-left';

            const name = document.createElement('div');
            name.className = 'file-name';
            name.textContent = it.file.name;

            const size = document.createElement('div');
            size.className = 'file-size';
            size.textContent = (it.file.size / 1024).toFixed(1) + ' KB';

            left.appendChild(name);
            left.appendChild(size);

            const progressWrap = document.createElement('div');
            progressWrap.className = 'progress-wrap';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.style.width = (it.progress || 0) + '%';
            progressWrap.appendChild(progressBar);

            const status = document.createElement('div');
            status.className = 'status';
            if (it.status === 'ready') status.innerHTML = '<span class="tag">Chu·∫©n b·ªã</span>';
            else if (it.status === 'uploading') status.innerHTML = '<span class="tag tag-primary">ƒêang upload ' + (it.progress||0) + '%</span>';
            else if (it.status === 'done') status.innerHTML = '<span class="tag tag-success">Ho√†n th√†nh</span>';
            else if (it.status === 'error') status.innerHTML = '<span class="tag tag-error">L·ªói: ' + (it.error || '') + '</span>';

            const actions = document.createElement('div');
            actions.className = 'actions';
            const delBtn = document.createElement('button');
            delBtn.className = 'btn-small';
            delBtn.textContent = 'X√≥a';
            delBtn.disabled = (it.status === 'uploading');
            delBtn.onclick = () => {
              if (it.xhr && it.xhr.readyState !== 4) it.xhr.abort();
              files.splice(idx, 1);
              renderList();
            };
            actions.appendChild(delBtn);

            row.appendChild(left);
            row.appendChild(progressWrap);
            row.appendChild(status);
            row.appendChild(actions);
            fileListEl.appendChild(row);
          });
        }

        function onFilesSelected(list) {
          const arr = Array.from(list).map((f) => ({
            file: f,
            progress: 0,
            status: 'ready',
            error: null,
            xhr: null
          }));
          files = files.concat(arr);
          renderList();
        }

        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
        dropzone.addEventListener('dragleave', (e) => { dropzone.classList.remove('dragover'); });
        dropzone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropzone.classList.remove('dragover');
          if (e.dataTransfer && e.dataTransfer.files) onFilesSelected(e.dataTransfer.files);
        });

        dropzone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files) onFilesSelected(e.target.files); e.target.value = ''; });

        uploadBtn.addEventListener('click', () => {
          serverResponse.textContent = '';
          if (files.length === 0) return;
          (async function uploadSequential() {
            for (let i = 0; i < files.length; i++) {
              if (files[i].status === 'done') continue;
              try { await uploadSingle(i); } catch (e) { console.error(e); }
            }
          })();
        });

        clearBtn.addEventListener('click', () => {
          files.forEach(it => { if (it.xhr && it.xhr.readyState !== 4) it.xhr.abort(); });
          files = [];
          serverResponse.textContent = '';
          renderList();
        });

        function uploadSingle(index) {
          return new Promise((resolve) => {
            const item = files[index];
            const form = new FormData();
            form.append('files', item.file);

            const xhr = new XMLHttpRequest();
            item.xhr = xhr;
            xhr.open('POST', '/api/upload', true);

            xhr.upload.onprogress = (e) => {
              if (!e.lengthComputable) return;
              const percent = Math.round((e.loaded / e.total) * 100);
              item.progress = percent;
              item.status = 'uploading';
              renderList();
            };

            xhr.onload = function () {
              if (xhr.status >= 200 && xhr.status < 300) {
                item.progress = 100;
                item.status = 'done';
                try {
                  const json = JSON.parse(xhr.responseText || '{}');
                  serverResponse.textContent = (json.message || (json.ok ? 'Upload th√†nh c√¥ng' : JSON.stringify(json))) ;
                } catch (e) {
                  serverResponse.textContent = 'Upload ho√†n t·∫•t';
                }
              } else {
                item.status = 'error';
                item.error = xhr.status + ' ' + xhr.statusText;
                serverResponse.textContent = 'L·ªói khi upload: ' + item.error;
              }
              renderList();
              resolve();
            };

            xhr.onerror = function () {
              item.status = 'error';
              item.error = 'Network error';
              serverResponse.textContent = 'L·ªói m·∫°ng khi upload';
              renderList();
              resolve();
            };

            xhr.onabort = function () {
              item.status = 'error';
              item.error = 'Aborted';
              renderList();
              resolve();
            };

            xhr.send(form);
          });
        }

        // accessibility
        dropzone.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
        });

        renderList();
      })();
    </script>
  </body>
</html>