<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Giải Bài Tập Cấp 2-3</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <script src="/main.js"></script>
  </head>
<body>
  <h1>Nộp bài cho assignment_id = 1 (ví dụ)</h1>
  <form id="uploadForm" enctype="multipart/form-data">
    <label for="files">Chọn file:</label>
    <input id="files" type="file" name="files" multiple accept=".pdf,.doc,.docx" />
    <br/>
    <textarea name="comment" placeholder="Ghi chú..."></textarea>
    <br/>
    <button type="submit">Nộp bài</button>
  </form>

  <hr/>
  <h2>Danh sách submissions (teacher view)</h2>
  <div id="subs"></div>

<script>
const ASSIGNMENT_ID = 1; 
const API_ROOT = "http://localhost:3000";


async function postSubmission(fd){
  const url = `${API_ROOT}/api/submissions?assignment_id=${ASSIGNMENT_ID}`;
  const res = await fetch(url, { method: 'POST', body: fd, credentials: 'include' });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const files = document.getElementById('files').files;
  if (!files.length) { alert('Chọn ít nhất 1 file'); return; }
  const fd = new FormData();
  for (const f of files) fd.append('files', f);
  fd.append('comment', e.target.comment.value || '');
  try {
    const j = await postSubmission(fd);
    alert('Nộp thành công: ' + JSON.stringify(j));
    await listSubs();
  } catch (err) {
    alert('Lỗi: ' + err.message);
  }
});

async function listSubs(){
  const res = await fetch(`${API_ROOT}/api/assignments/${ASSIGNMENT_ID}/submissions`, { credentials: 'include' });
  if (!res.ok) { document.getElementById('subs').textContent = 'Không lấy được submissions'; return; }
  const j = await res.json();
  const div = document.getElementById('subs');
  div.innerHTML = '';
  if (!j.submissions || !j.submissions.length) { div.textContent = 'Chưa có submission nào.'; return; }
  j.submissions.forEach(s => {
    const d = document.createElement('div');
    const atts = (s.attachments||[]).map(a => `<a href="${a.url}" target="_blank">${a.filename}</a>`).join(' ');
    d.innerHTML = `<strong>${s.display_name || ('User '+s.user_id)}</strong> - ${s.submitted_at || ''} - ${s.status || ''}
                   <div>${s.comment || ''}</div><div>${atts}</div>`;
    div.appendChild(d);
  });
}

listSubs();
</script>
</body>
</html>