<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Đăng nhập — FP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="main.css">
  <style>
    .auth-box { max-width:420px; margin:40px auto; padding:20px; border:1px solid #eee; border-radius:8px; background:#fff; }
    .auth-box label { display:block; margin-bottom:6px; font-weight:600; }
    .auth-box input { width:100%; padding:8px 10px; margin-bottom:12px; border-radius:6px; border:1px solid #ddd; }
    .auth-box button { padding:8px 12px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('login-form');
  if (!form) return;

  // Prevent double handlers: remove inline action to avoid browser native submit if present
  try { form.removeAttribute('action'); } catch(e){}

  form.addEventListener('submit', async function (ev) {
    ev.preventDefault();

    const fd = new FormData(form);
    const payload = {
      username: (fd.get('username') || fd.get('email') || '').toString(),
      password: (fd.get('password') || '').toString()
    };

    const apiPath = (typeof window.apiUrl === 'function') ? window.apiUrl('/api/login') : (window.API_BASE ? window.API_BASE.replace(/\/$/,'') + '/api/login' : '/api/login');

    try {
      const res = await fetch(apiPath, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const text = await res.text().catch(()=>null);
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e) { json = null; }

      if (res.ok && json && json.ok) {
        // Nếu là admin thì redirect tới admin.html, ngược lại về homepage
        try {
          if (json.user && json.user.role === 'admin') {
            window.location.href = '/admin.html';
          } else {
            window.location.href = '/';
          }
        } catch (e) {
          // fallback
          window.location.href = '/';
        }
      } else {
        const errMsg = (json && (json.error || json.message)) ? (json.error || json.message) : (text || ('HTTP ' + res.status));
        alert('Đăng nhập thất bại: ' + errMsg);
      }
    } catch (err) {
      console.error('Login fetch error', err);
      alert('Lỗi khi kết nối tới server: ' + (err && err.message ? err.message : String(err)));
    }
  }, { passive: false });
});
</script>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="branding">
        <a href="/" class="logo">FP</a>
      </div>
      <nav class="site-nav" id="nav">
        <a href="register.html" id="link-register" class="nav-link">Đăng ký</a>
        <a href="login.html" id="link-login" class="nav-link">Đăng nhập</a>
        <a href="#" id="link-logout" class="nav-link" style="display:none">Đăng xuất</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="auth-box">
      <h2>Đăng nhập</h2>
      <form id="login-form" method="post" action="/api/login">
        <label for="username">Tên đăng nhập hoặc email</label>
        <input id="username" name="username" type="text" autocomplete="username" required />
        <label for="password">Mật khẩu</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required />
        <div style="display:flex;gap:8px;align-items:center">
          <button type="submit">Đăng nhập</button>
          <a href="register.html" style="margin-left:auto">Chưa có tài khoản?</a>
        </div>
      </form>
      <div style="margin-top:12px;color:#666;font-size:0.9rem">Ghi chú: form này được submit bằng AJAX và sẽ giữ session nếu server trả Set-Cookie.</div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container"><small>© FP</small></div>
  </footer>
<script>
  // Dev default: nếu frontend tách origin, set API_BASE phù hợp
  window.API_BASE = window.API_BASE || 'http://localhost:5001';
</script>
  <script src="subject-links.js"></script>
</body>
</html>