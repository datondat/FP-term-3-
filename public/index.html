<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>FP — Trang chủ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <header class="top-header">
    <div class="header-left">
      <a href="/"><img src="logo.png" alt="logo" class="logo"></a>
      <div>
        <h1>FP — Hệ thống học tập</h1>
        <div class="tagline small muted">Trang quản lý người dùng & danh sách môn</div>
      </div>
    </div>

    <nav class="menu-class" aria-label="Lớp">
      <a href="#" class="menu-item active">Lớp 6</a>
      <a href="#" class="menu-item">Lớp 7</a>
      <a href="#" class="menu-item">Lớp 8</a>
      <a href="#" class="menu-item">Lớp 9</a>
      <a href="#" class="menu-item">Lớp 10</a>
      <a href="#" class="menu-item">Lớp 11</a>
      <a href="#" class="menu-item">Lớp 12</a>
      <a href="upload-assignments.html" class="menu-item menu-upload" id="link-upload"><i class="fa fa-upload"></i> Tải bài tập</a>
    </nav>

    <div class="header-right">
      <form class="search-form" role="search" onsubmit="return false">
        <input class="search-input" placeholder="Tìm môn, lớp..." />
        <button class="search-btn" aria-label="Search"><i class="fa fa-search"></i></button>
      </form>

      <div class="user-area">
        <img src="avatar.png" alt="avatar" class="avatar" id="avatarBtn">
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card" id="main">
      <div id="status-block" data-status-prompt>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap">
          <div>
            <h2 id="status-title">Bạn chưa đăng nhập</h2>
            <div id="status-desc" class="muted">Bạn có thể đăng nhập hoặc đăng ký để truy cập các tính năng bảo mật.</div>
          </div>
          <div>
            <a href="login.html" class="btn btn-ghost" id="link-login"><i class="fa fa-right-to-bracket"></i> Đăng nhập</a>
            <a href="register.html" class="btn" id="link-register"><i class="fa fa-user-plus"></i> Đăng ký</a>
            <a href="upload-assignments.html" class="btn btn-ghost" id="btn-upload-quick"><i class="fa fa-upload"></i> Tải bài tập</a>
          </div>
        </div>
      </div>

      <div id="user-card" class="card hidden" style="margin-top:16px">
        <h3>Thông tin tài khoản</h3>
        <div id="user-info" class="muted"></div>
        <div class="user-actions" style="margin-top:12px">
          <button id="btn-logout" class="btn btn-ghost"><i class="fa fa-sign-out-alt"></i> Đăng xuất</button>
          <button id="btn-test" class="btn"><i class="fa fa-lock"></i> Gọi API bảo mật</button>
        </div>
        <div id="api-result" class="api-result" style="margin-top:10px"></div>
      </div>

      <div id="messages" style="margin-top:12px">
        <div id="msg" class="ok" style="display:none"></div>
        <div id="err" class="err" style="display:none"></div>
      </div>
    </section>

    <section class="card subjects-view" id="subjects">
      <h3 class="service-title">Danh sách môn theo nhóm lớp</h3>
      <p class="small muted">Nhấp vào môn để xem mô tả mẫu và liên kết SGK / SBT tương ứng. Nhấn link để mở trang sách.</p>

      <div class="grid" style="margin-top:12px">
        <div class="grade">
          <h4>Lớp 6 — 9</h4>
          <div class="two-col">
            <div>
              <strong>Lớp 6</strong>
              <ul id="grade-6"></ul>
            </div>
            <div>
              <strong>Lớp 7</strong>
              <ul id="grade-7"></ul>
            </div>
            <div>
              <strong>Lớp 8</strong>
              <ul id="grade-8"></ul>
            </div>
            <div>
              <strong>Lớp 9</strong>
              <ul id="grade-9"></ul>
            </div>
          </div>
        </div>

        <div class="grade">
          <h4>Lớp 10 — 12</h4>
          <div class="two-col">
            <div>
              <strong>Lớp 10</strong>
              <ul id="grade-10"></ul>
            </div>
            <div>
              <strong>Lớp 11</strong>
              <ul id="grade-11"></ul>
            </div>
            <div>
              <strong>Lớp 12</strong>
              <ul id="grade-12"></ul>
            </div>
            <div>
              <strong>Chung</strong>
              <ul id="grade-common"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="subject-detail" class="subject-detail" style="display:none; margin-top:12px">
        <h4 id="subject-title"></h4>
        <div id="subject-desc" class="muted"></div>
        <div id="subject-books" class="subject-books" style="margin-top:8px"></div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3>Ghi chú</h3>
      <ul>
        <li>Nhấn vào tên môn → danh sách sách giáo khoa / sách bài tập sẽ hiện ở khung chi tiết.</li>
        <li>Link mở trang sách (hoc10.vn) trong tab mới.</li>
      </ul>
    </section>

    <footer class="site-footer">
      <div>© FP — Hệ thống học tập</div>
    </footer>
  </main>

  <!-- Inline script: đảm bảo subjects được populate ngay cả khi public/index.js chưa chạy hoặc bị lỗi.
       Điều này chứa logic fallback: nếu window.FP.populateSubjects tồn tại thì gọi nó,
       ngược lại sẽ populate tại chỗ và gắn delegation để hiển thị links tìm kiếm hoc10. -->
  <script>
    (function(){
      'use strict';
      // Dữ liệu môn tạm (giống với index.js) — dùng nếu không có window.FP.populateSubjects
      const subjectsByGrade = {
        6:['Toán','Ngữ văn','Tiếng Anh','Khoa học tự nhiên','Lịch sử','Địa lí','Tin học','Công nghệ','GDCD'],
        7:['Toán','Ngữ văn','Tiếng Anh','Vật lí','Hóa học','Sinh học','Lịch sử','Địa lí','Công nghệ'],
        8:['Toán','Ngữ văn','Tiếng Anh','Vật lí','Hóa học','Sinh học','Lịch sử','Địa lí','Tin học'],
        9:['Toán','Ngữ văn','Tiếng Anh','Vật lí','Hóa học','Sinh học','Lịch sử','Địa lí','GDQPAN'],
        10:['Toán (Tự chọn/Chuyên)','Ngữ văn','Tiếng Anh','Vật lí','Hóa học','Sinh học','Tin học','GDCD'],
        11:['Toán','Ngữ văn','Tiếng Anh','Vật lí','Hóa học','Sinh học','Tin học','GDQPAN'],
        12:['Toán','Ngữ văn','Tiếng Anh','Vật lí','Hóa học','Sinh học','Tin học','Lịch sử & Địa lí'],
        common:['Giáo dục công dân','Công nghệ','Khoa học tự nhiên','Giáo dục kinh tế và pháp luật']
      };

      function hoc10Search(subject, grade){
        return 'https://www.hoc10.vn/tim-kiem?q=' + encodeURIComponent(subject + (grade ? ' ' + grade : ''));
      }

      function createSubjectItem(name, grade){
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'subject';
        a.textContent = name;
        a.dataset.subject = name;
        a.dataset.grade = grade;
        a.setAttribute('data-desc', `Mô tả mẫu cho môn "${name}".`);
        li.appendChild(a);
        return li;
      }

      function fallbackPopulate(){
        try {
          Object.keys(subjectsByGrade).forEach(function(g){
            const ul = document.getElementById('grade-' + g);
            if(!ul) return;
            if(ul.children.length === 0){
              ul.innerHTML = '';
              subjectsByGrade[g].forEach(function(name){
                ul.appendChild(createSubjectItem(name, g));
              });
            }
          });
          installDelegation(); // đảm bảo click hoạt động
          console.info('[FP inline fallback] subjects populated');
        } catch(e){
          console.error('[FP inline fallback] error populating subjects', e);
        }
      }

      // Biến helper: hiện khung detail với link fallback (search hoc10)
      function showDetailFallback(subject, grade){
        const title = document.getElementById('subject-title');
        const desc = document.getElementById('subject-desc');
        const booksEl = document.getElementById('subject-books');
        const wrap = document.getElementById('subject-detail');
        if(title) title.textContent = subject;
        if(desc) desc.textContent = `Tài liệu tham khảo cho ${subject} (Lớp ${grade}).`;
        if(booksEl){
          booksEl.innerHTML = '';
          const a = document.createElement('a');
          a.className = 'book-link';
          a.href = hoc10Search(subject, grade);
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = `Tìm sách trên hoc10 cho ${subject} — Lớp ${grade}`;
          booksEl.appendChild(a);
        }
        if(wrap) wrap.style.display = 'block';
        try { window.scrollTo({ top: wrap.offsetTop - 20, behavior: 'smooth' }); } catch(e){}
      }

      // Delegation handler: nếu index.js đã cài đặt behaviour thì nó sẽ override; nếu không thì dùng fallback này
      function installDelegation(){
        const container = document.querySelector('.subjects-view') || document.body;
        if(container._fpInlineDelegationInstalled) return;
        container.addEventListener('click', function(e){
          let el = e.target;
          while(el && el !== container){
            if(el.matches && el.matches('a.subject')){
              e.preventDefault();
              const subject = el.dataset.subject || el.textContent.trim();
              const grade = el.dataset.grade || (el.closest && el.closest('[id^="grade-"]') ? el.closest('[id^="grade-"]').id.replace('grade-','') : 'unknown');
              // prefer window.FP.showSubjectDetail if available (index.js likely defines it)
              if(window.FP && typeof window.FP.showSubjectDetail === 'function'){
                try { window.FP.showSubjectDetail(subject, grade); return; } catch(e){ /* fallthrough */ }
              }
              // fallback to simple search link
              showDetailFallback(subject, grade);
              return;
            }
            el = el.parentNode;
          }
        }, false);
        container._fpInlineDelegationInstalled = true;
      }

      // Ensure auth/login links navigate even if other scripts block default
      function ensureAuthLinksNavigate(){
        ['link-login','link-register','link-upload','btn-upload-quick'].forEach(function(id){
          const el = document.getElementById(id);
          if(!el) return;
          // capture phase so it runs before other listeners that might prevent default
          el.addEventListener('click', function(ev){
            const href = el.getAttribute('href') || el.dataset.href;
            if(href) {
              window.location.assign(href);
              ev.stopImmediatePropagation();
            }
          }, { capture: true });
        });
      }

      // Entry: on DOMContentLoaded decide whether to call external populate or fallback
      function initInline(){
        ensureAuthLinksNavigate();
        // If external index.js loaded and defines populateSubjects, use that.
        if(window.FP && typeof window.FP.populateSubjects === 'function'){
          try {
            window.FP.populateSubjects();
            // ensure delegation is installed by external script (but install fallback if not)
            if(!(document.querySelector('.subjects-view')._fpDelegationInstalled)) installDelegation();
            console.info('[FP inline] used window.FP.populateSubjects');
            return;
          } catch(e){
            console.warn('[FP inline] window.FP.populateSubjects threw, using fallback', e);
          }
        }
        // Otherwise, run fallback populate + delegation
        fallbackPopulate();
      }

      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', initInline);
      } else {
        initInline();
      }
    })();
  </script>

  <!-- External runtime (contains full populate/show functions). Keep this. -->
  <script src="index.js"></script>
</body>
</html>