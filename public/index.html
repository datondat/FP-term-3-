<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>FP - Trang chủ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div style="display:flex;align-items:center;gap:12px;">
        <a href="/" class="logo">FP</a>
        <div class="site-sub">Hệ thống học tập</div>
      </div>

      <div class="header-search">
        <input id="global-search" type="search" placeholder="Tìm môn hoặc tài liệu (nhấn Enter)" />
      </div>

      <nav class="site-nav" id="nav">
        <a href="register.html" id="link-register" class="nav-link">Đăng ký</a>
        <a href="login.html" id="link-login" class="nav-link">Đăng nhập</a>
        <a href="#" id="link-logout" class="nav-link" style="display:none">Đăng xuất</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div>
          <h3 style="margin:0">Danh sách khối</h3>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="back-all" class="btn-ghost" title="Quay lại tất cả">Quay lại tất cả</button>
        </div>
      </div>

      <!-- Flat grid of grade panels -->
      <div id="grades-area" class="cards-grid grades-wrapper" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
        <div class="grade-panel" data-grade="6">
          <div class="grade-title">Lớp 6</div>
          <ul id="grade-6" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="7">
          <div class="grade-title">Lớp 7</div>
          <ul id="grade-7" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="8">
          <div class="grade-title">Lớp 8</div>
          <ul id="grade-8" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="9">
          <div class="grade-title">Lớp 9</div>
          <ul id="grade-9" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="10">
          <div class="grade-title">Lớp 10</div>
          <ul id="grade-10" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="11">
          <div class="grade-title">Lớp 11</div>
          <ul id="grade-11" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="12">
          <div class="grade-title">Lớp 12</div>
          <ul id="grade-12" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="common">
          <div class="grade-title">Chung</div>
          <ul id="grade-common" class="subject-grid subject-list"></ul>
        </div>
      </div>
    </section>

    <!-- Subject detail card (hidden until a subject is selected) -->
    <section id="subject-detail-card" class="card" style="display:none">
      <div class="flex-space">
        <div>
          <h3 id="subject-detail-title">Môn</h3>
          <div id="subject-detail-meta" class="small muted"></div>
        </div>
        <div>
          <button id="back-to-grade" class="btn-ghost">Quay lại</button>
        </div>
      </div>
      <div id="subject-detail-body" style="margin-top:12px">
        <!-- subject info inserted here -->
      </div>
    </section>

  </main>

  <footer class="site-footer">
    <div class="container">
      <small>© FP — Hệ thống học tập</small>
    </div>
  </footer>

<script>
  window.API_BASE = window.API_BASE || 'http://localhost:5001';
</script>

<script src="subject-links.js"></script>

<!-- Compact file-grid renderer: run after subject-links.js -->
<script>
/* Normalize and render file links as compact grid buttons.
   Run after subject-links.js has populated panels. Safe to call multiple times. */
(function renderCompactFileButtons(){
  const FILE_EXT_RE = /\.(pdf|docx?|pptx?|xlsx?)$/i;

  document.querySelectorAll('.grade-panel').forEach(panel => {
    // 1) Collect existing anchors that look like file links (href ends with file ext or text includes extension)
    const anchors = Array.from(panel.querySelectorAll('a')).filter(a => {
      const href = (a.getAttribute('href') || '').trim();
      const txt = (a.textContent || '').trim();
      return FILE_EXT_RE.test(href) || FILE_EXT_RE.test(txt);
    });

    // 2) Collect plain-text filenames inside panel (fallback)
    const textMatches = [];
    Array.from(panel.querySelectorAll('*')).forEach(node => {
      if (node.children.length === 0) {
        const t = (node.textContent || '').trim();
        if (!t) return;
        const m = t.match(new RegExp('([^\\n\\r]+?\\.(?:pdf|docx?|pptx?|xlsx?))','gi'));
        if (m && m.length) {
          m.forEach(x => {
            const s = x.trim();
            const exists = anchors.some(a => (a.textContent||'').trim() === s);
            if (!exists) textMatches.push(s);
          });
        }
      }
    });

    if (anchors.length === 0 && textMatches.length === 0) {
      return;
    }

    const existingGrid = panel.querySelector('.file-grid');
    if (existingGrid) existingGrid.remove();

    const grid = document.createElement('div');
    grid.className = 'file-grid';

    const makeLinkItem = (href, label) => {
      const wrap = document.createElement('div');
      wrap.className = 'file-grid-item';
      const a = document.createElement('a');
      a.href = href;
      a.textContent = label;
      a.title = label;
      a.classList.add('btn-file');
      wrap.appendChild(a);
      return wrap;
    };

    anchors.forEach(a => {
      const href = a.getAttribute('href') || ('/file.html?name=' + encodeURIComponent((a.textContent||'').trim()));
      const label = (a.textContent||'').trim().slice(0,40);
      const item = makeLinkItem(href, label);
      grid.appendChild(item);
    });

    textMatches.forEach(name => {
      const href = '/file.html?name=' + encodeURIComponent(name);
      const label = name.length > 40 ? name.slice(0,37) + '...' : name;
      grid.appendChild(makeLinkItem(href, label));
    });

    // Insert grid into panel
    const headings = Array.from(panel.querySelectorAll('strong, h3, h4, div')).filter(el => /file\s*từ\s*drive|liên\s*kết\s*tài\s*liệu/i.test((el.textContent||'')));
    if (headings.length) {
      headings[0].insertAdjacentElement('afterend', grid);
    } else {
      panel.appendChild(grid);
    }

    // Remove raw anchors/text nodes that matched filenames to avoid duplication
    anchors.forEach(a => { try { a.remove(); } catch(e){} });
    Array.from(panel.querySelectorAll('*')).forEach(node => {
      if (node.children.length === 0) {
        const t = (node.textContent || '').trim();
        if (t && FILE_EXT_RE.test(t)) {
          node.remove();
        }
      }
    });

  });
})();
</script>

<script>
(function(){
  const gradesArea = document.getElementById('grades-area');
  const panels = Array.from(document.querySelectorAll('.grade-panel'));
  const subjectDetailCard = document.getElementById('subject-detail-card');
  const subjectDetailTitle = document.getElementById('subject-detail-title');
  const subjectDetailMeta = document.getElementById('subject-detail-meta');
  const subjectDetailBody = document.getElementById('subject-detail-body');
  const backBtn = document.getElementById('back-to-grade');
  const backAllBtn = document.getElementById('back-all');

  function clearGradeSelection() {
    panels.forEach(p => {
      p.classList.remove('grade-selected');
      p.classList.remove('hidden');
      const ul = p.querySelector('.subject-list');
      if (ul) ul.classList.remove('show-subjects');
    });
    subjectDetailCard.style.display = 'none';
  }

  panels.forEach(panel => {
    panel.addEventListener('click', (ev) => {
      // ignore clicks on links
      if (ev.target && (ev.target.tagName === 'A' || ev.target.closest('a'))) return;
      panels.forEach(p => { if (p !== panel) p.classList.add('hidden'); });
      panel.classList.add('grade-selected');
      const ul = panel.querySelector('.subject-list');
      if (ul) ul.classList.add('show-subjects');
      subjectDetailCard.style.display = 'none';
      panel.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });

  gradesArea.addEventListener('click', (ev) => {
    const a = ev.target.closest('a');
    if (a) {
      if (a.getAttribute('href') && a.getAttribute('href').includes('/file.html')) {
        a.classList.add('btn-file');
        return; // allow navigation
      }
    }
    const subjectLi = ev.target.closest('li, .subject-item');
    if (!subjectLi) return;
    ev.preventDefault();
    const subjectName = subjectLi.dataset.subject || subjectLi.textContent.trim();
    const panel = subjectLi.closest('.grade-panel');
    const grade = panel && panel.dataset.grade ? panel.dataset.grade : '';
    panels.forEach(p => {
      if (p !== panel) p.classList.add('hidden');
      const ul = p.querySelector('.subject-list');
      if (ul) ul.classList.remove('show-subjects');
    });
    subjectDetailTitle.textContent = subjectName;
    subjectDetailMeta.textContent = 'Khối: ' + (grade || '—');
    const insideLinks = Array.from(subjectLi.querySelectorAll('a'));
    subjectDetailBody.innerHTML = '';
    if (insideLinks.length) {
      insideLinks.forEach(link => {
        const clone = link.cloneNode(true);
        clone.classList.add('btn-file');
        clone.style.display = 'inline-block';
        clone.style.marginRight = '8px';
        subjectDetailBody.appendChild(clone);
      });
    } else {
      subjectDetailBody.innerHTML = '<div class="muted">Không có tài liệu trực tiếp cho môn này.</div>';
    }
    subjectDetailCard.style.display = 'block';
    subjectDetailCard.scrollIntoView({behavior:'smooth', block:'start'});
  });

  backBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    const sel = document.querySelector('.grade-panel.grade-selected');
    if (!sel) { clearGradeSelection(); return; }
    subjectDetailCard.style.display = 'none';
    panels.forEach(p => { if (p !== sel) p.classList.add('hidden'); });
    const ul = sel.querySelector('.subject-list');
    if (ul) ul.classList.add('show-subjects');
    sel.scrollIntoView({behavior:'smooth', block:'start'});
  });

  backAllBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    panels.forEach(p => p.classList.remove('hidden', 'grade-selected'));
    document.querySelectorAll('.subject-list').forEach(ul => ul.classList.remove('show-subjects'));
    subjectDetailCard.style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  const logo = document.querySelector('.logo');
  if (logo) logo.addEventListener('click', (e) => {
    panels.forEach(p => p.classList.remove('hidden', 'grade-selected'));
    document.querySelectorAll('.subject-list').forEach(ul => ul.classList.remove('show-subjects'));
    subjectDetailCard.style.display = 'none';
  });

  window.FP_UI = { reset: clearGradeSelection };

})();
</script>
</body>
</html>