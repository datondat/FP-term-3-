<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Gi·∫£i B√†i T·∫≠p C·∫•p 2-3</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/textbooks.css" />
    <script src="/main.js" defer></script>
    <script src="/textbooks.js" defer></script>
  </head>
  <body>
    <!-- TOP HEADER -->
    <header class="top-header">
      <div class="header-left">
        <img src="/images/bookshelf.jpg" alt="Bookshelf" class="bookshelf logo" />
      </div>

      <nav class="menu-class" aria-label="Menu l·ªõp">
        <a href="#" data-class="L·ªõp 6">L·ªõp 6</a>
        <a href="#" data-class="L·ªõp 7">L·ªõp 7</a>
        <a href="#" data-class="L·ªõp 8">L·ªõp 8</a>
        <a href="#" data-class="L·ªõp 9">L·ªõp 9</a>
        <a href="#" data-class="L·ªõp 10">L·ªõp 10</a>
        <a href="#" data-class="L·ªõp 11">L·ªõp 11</a>
        <a href="#" data-class="L·ªõp 12">L·ªõp 12</a>
        <a href="#" data-class="Gi√°o √°n - ƒê·ªÅ thi">Gi√°o √°n - ƒê·ªÅ thi</a>
        <a href="/upload-assignment.html" class="menu-upload">Upload</a>
      </nav>

      <div class="header-right">
        <form class="search-form" id="searchForm">
          <input class="search-input" name="q" type="search" placeholder="T√¨m ki·∫øm m√¥n, t√†i li·ªáu..." aria-label="T√¨m ki·∫øm" />
          <button class="search-btn" type="submit" aria-label="T√¨m">üîç</button>
        </form>
        <div class="user-area">
          <img src="/images/avatar.png" alt="Avatar" class="avatar" id="avatarBtn" title="T√†i kho·∫£n" />
          <div class="dropdown" id="userDropdown" aria-hidden="true">
            <div id="userNotLogged">
              <a href="#" class="dropdown-item" id="openLogin">ƒêƒÉng nh·∫≠p</a>
              <a href="#" class="dropdown-item">ƒêƒÉng k√Ω</a>
            </div>
            <div id="userLogged" style="display: none">
              <div class="dropdown-item" id="userNameDisplay"></div>
              <a href="#" class="dropdown-item" id="logoutBtn">ƒêƒÉng xu·∫•t</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT (below header) -->
    <main id="mainContent">
      <!-- INLINE LOGIN (·∫©n m·∫∑c ƒë·ªãnh) -->
      <section id="inlineLogin" class="inline-login hidden" aria-hidden="true">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <form id="inlineLoginForm" class="inline-login-form">
          <label>Username <input type="text" name="username" required /></label>
          <label>Password <input type="password" name="password" required /></label>
          <div class="inline-actions">
            <button type="submit" class="btn">ƒêƒÉng nh·∫≠p</button>
            <button type="button" class="btn btn-ghost" id="inlineCancel">H·ªßy</button>
          </div>
        </form>
      </section>

      <!-- SERVICES -->
      <div class="service-area" id="serviceArea">
        <div class="service-title">WEB H·ªåC T·∫¨P</div>
        <div class="services">
          <div class="service-box"><div class="icon">üìù</div><div class="name">Gi·∫£i b√†i t·∫≠p SGK & SBT</div></div>
          <div class="service-box"><div class="icon">üìö</div><div class="name">S√°ch</div></div>
          <div class="service-box"><div class="icon">üéì</div><div class="name">Kh√≥a h·ªçc</div></div>
          <a href="/upload-assignment.html" class="service-box service-box-upload" aria-label="Upload t√†i li·ªáu"><div class="icon">‚¨ÜÔ∏è</div><div class="name">Upload t√†i li·ªáu</div></a>
        </div>
      </div>

      <!-- CATEGORY / ACCORDION (all classes listed) -->
      <div class="category-area" id="categoryArea">
        <div class="category-title">Danh m·ª•c gi·∫£i b√†i t·∫≠p v√† so·∫°n b√†i</div>
        <div class="category-intro">Click v√†o n√∫t L·ªõp ·ªü menu tr√™n ƒë·ªÉ xem c√°c m√¥n.</div>

        <div class="accordion" id="classAccordion">
          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 6" type="button"><span>L·ªõp 6</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 6. Bao g·ªìm SGK, SBT, b√†i t·∫≠p v√† h∆∞·ªõng d·∫´n.</p></div>
          </div>

          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 7" type="button"><span>L·ªõp 7</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 7. B√†i t·∫≠p, s√°ch v√† t√†i li·ªáu tham kh·∫£o.</p></div>
          </div>

          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 8" type="button"><span>L·ªõp 8</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 8. G·ªìm To√°n, V·∫≠t l√Ω, H√≥a h·ªçc, Ng·ªØ vƒÉn...</p></div>
          </div>

          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 9" type="button"><span>L·ªõp 9</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 9. T√†i li·ªáu √¥n thi v√† b√†i gi·∫£i m·∫´u.</p></div>
          </div>

          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 10" type="button"><span>L·ªõp 10</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 10. Th√≠ch h·ª£p cho nƒÉm h·ªçc THPT.</p></div>
          </div>

          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 11" type="button"><span>L·ªõp 11</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 11. G·ªìm b√†i gi·∫£ng, b√†i t·∫≠p v√† ƒë·ªÅ ki·ªÉm tra.</p></div>
          </div>

          <div class="accordion-item">
            <button class="accordion-button" data-class="L·ªõp 12" type="button"><span>L·ªõp 12</span><span class="arrow">&#9654;</span></button>
            <div class="accordion-panel"><p>N·ªôi dung t√≥m t·∫Øt cho l·ªõp 12. T√†i li·ªáu √¥n thi ƒë·∫°i h·ªçc v√† ƒë·ªÅ thi th·ª≠.</p></div>
          </div>
        </div>
      </div>

      <!-- SUBJECTS VIEW (list of subjects for a chosen class) -->
      <div id="subjectsView" class="subjects-view hidden" aria-hidden="true">
        <div class="subjects-header">
          <button id="backToClasses" class="btn btn-ghost">‚Üê Quay l·∫°i</button>
          <h2 id="subjectsTitle">C√°c m√¥n</h2>
        </div>
        <div id="subjectsGrid" class="subjects-grid"></div>
      </div>

      <!-- RESOURCES VIEW: when user clicks a subject, hide everything under header and show this -->
      <div id="resourcesView" class="resources-view hidden" aria-hidden="true">
        <div class="resources-header">
          <button id="resourcesBack" class="btn btn-ghost">‚Üê Quay l·∫°i</button>
          <h2 id="resourcesTitle">T√†i li·ªáu</h2>
        </div>
        <div id="resourcesBody" class="resources-body">
          <!-- textbooks.js can render HTML here (uses same markup as textbooks page) -->
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">¬© FP-term-3</div>
    </footer>

    <script>
      // full class -> subjects map
      const classSubjects = {
        "L·ªõp 6": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","Khoa h·ªçc t·ª± nhi√™n","L·ªãch s·ª≠","ƒê·ªãa l√Ω","Tin h·ªçc"],
        "L·ªõp 7": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","V·∫≠t l√Ω","Sinh h·ªçc","C√¥ng ngh·ªá","Tin h·ªçc"],
        "L·ªõp 8": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","V·∫≠t l√Ω","H√≥a h·ªçc","L·ªãch s·ª≠","ƒê·ªãa l√Ω"],
        "L·ªõp 9": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","V·∫≠t l√Ω","H√≥a h·ªçc","Sinh h·ªçc","C√¥ng ngh·ªá"],
        "L·ªõp 10": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","V·∫≠t l√Ω","H√≥a h·ªçc","Sinh h·ªçc","GDCD"],
        "L·ªõp 11": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","V·∫≠t l√Ω","H√≥a h·ªçc","Sinh h·ªçc","Tin h·ªçc"],
        "L·ªõp 12": ["To√°n","Ng·ªØ vƒÉn","Ti·∫øng Anh","V·∫≠t l√Ω","H√≥a h·ªçc","Sinh h·ªçc","L·ªãch s·ª≠"],
        "Gi√°o √°n - ƒê·ªÅ thi": ["ƒê·ªÅ thi THCS","ƒê·ªÅ thi THPT","Gi√°o √°n m·∫´u"]
      };

      const serviceArea = document.getElementById('serviceArea');
      const categoryArea = document.getElementById('categoryArea');
      const subjectsView = document.getElementById('subjectsView');
      const resourcesView = document.getElementById('resourcesView');

      // show subjects for a class
      function showSubjects(className) {
        const subjects = classSubjects[className] || [];
        const grid = document.getElementById("subjectsGrid");
        const title = document.getElementById("subjectsTitle");
        grid.innerHTML = "";
        title.textContent = `C√°c m√¥n c·ªßa ${className}`;
        if (subjects.length === 0) {
          grid.innerHTML = "<p>Ch∆∞a c√≥ m√¥n cho l·ªõp n√†y.</p>";
        } else {
          subjects.forEach((sub) => {
            const card = document.createElement("div");
            card.className = "subject-card";
            // When clicking the subject card, show resources inline (no modal)
            card.innerHTML = `
              <div class="subject-name">${sub}</div>
              <div style="display:flex;gap:8px;justify-content:center">
                <button class="btn view-subject inline" data-sub="${sub}" data-class="${className}">Xem s√°ch</button>
              </div>
            `;
            grid.appendChild(card);
          });
        }

        // show subjects view, hide other main content parts (except header)
        serviceArea.classList.add('hidden');
        categoryArea.classList.add('hidden');
        resourcesView.classList.add('hidden');
        subjectsView.classList.remove('hidden');
        subjectsView.setAttribute("aria-hidden","false");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function hideSubjects() {
        subjectsView.classList.add('hidden');
        subjectsView.setAttribute('aria-hidden','true');
        serviceArea.classList.remove('hidden');
        categoryArea.classList.remove('hidden');
      }

      // show resources inline for a given class+subject
      async function showResourcesInline(className, subject) {
        // hide everything under header
        serviceArea.classList.add('hidden');
        categoryArea.classList.add('hidden');
        subjectsView.classList.add('hidden');

        const resourcesBody = document.getElementById('resourcesBody');
        const resourcesTitle = document.getElementById('resourcesTitle');
        resourcesTitle.textContent = `${subject} ‚Äî ${className}`;

        // load textbooks data via Textbooks.loadData() (textbooks.js exposes this)
        try {
          const data = await window.Textbooks.loadData();
          const books = (data[className] || {})[subject] || [];
          // render HTML using the same helper exposed by textbooks.js
          const html = window.Textbooks.renderBooksListHTML
            ? window.Textbooks.renderBooksListHTML(className, subject, books)
            : (books.length ? books.map(b => `<div>${b.title} ‚Äî <a href="${b.link}" target="_blank">Xem</a></div>`).join('') : '<div class="muted">Ch∆∞a c√≥ s√°ch.</div>');

          resourcesBody.innerHTML = html;
        } catch (err) {
          resourcesBody.innerHTML = '<div class="muted">L·ªói t·∫£i d·ªØ li·ªáu s√°ch.</div>';
        }

        resourcesView.classList.remove('hidden');
        resourcesView.setAttribute('aria-hidden','false');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // attach top menu handlers
      document.querySelectorAll(".menu-class a[data-class]").forEach((a) => {
        a.addEventListener("click", function (e) {
          e.preventDefault();
          const cls = this.dataset.class;
          showSubjects(cls);
        });
      });

      // accordion buttons also show subjects
      document.querySelectorAll(".accordion-button").forEach((btn) => {
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          const cls = this.dataset.class;
          showSubjects(cls);
        });
      });

      // delegate clicks for inline "Xem s√°ch" buttons in subjects grid
      document.addEventListener('click', function (e) {
        const btn = e.target.closest && e.target.closest('.view-subject.inline');
        if (!btn) return;
        const sub = btn.dataset.sub;
        const cls = btn.dataset.class;
        showResourcesInline(cls, sub);
      });

      // resources back button
      document.getElementById('resourcesBack').addEventListener('click', function () {
        // go back to subjects list if it was visible previously; otherwise restore main content
        resourcesView.classList.add('hidden');
        resourcesView.setAttribute('aria-hidden','true');
        // show category & services (user can click class again)
        serviceArea.classList.remove('hidden');
        categoryArea.classList.remove('hidden');
        // clear body
        document.getElementById('resourcesBody').innerHTML = '';
      });

      // subjects back button returns to main category view
      document.getElementById('backToClasses').addEventListener('click', hideSubjects);

      // search handler (unchanged)
      document.getElementById("searchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const q = new FormData(e.target).get("q") || "";
        try {
          const res = await fetch("/api/search?q=" + encodeURIComponent(q));
          const data = await res.json();
          alert("K·∫øt qu·∫£: " + (data.results && data.results.length ? data.results.map((r) => r.title).join(", ") : "Kh√¥ng c√≥"));
        } catch (err) { alert("L·ªói t√¨m ki·∫øm"); }
      });

      // inline login open/cancel (unchanged)
      document.getElementById("openLogin").addEventListener("click", (e) => {
        e.preventDefault();
        const inline = document.getElementById("inlineLogin");
        inline.classList.remove("hidden");
        inline.scrollIntoView({ behavior: "smooth", block: "center" });
        inline.querySelector('input[name="username"]').focus();
        document.getElementById("userDropdown").classList.remove("open");
      });
      document.getElementById("inlineCancel").addEventListener("click", () => {
        document.getElementById("inlineLogin").classList.add("hidden");
      });

      // load user (unchanged)
      async function loadUser() {
        try {
          const r = await fetch("/api/me");
          const j = await r.json();
          const logged = j.user;
          const userNot = document.getElementById("userNotLogged");
          const userLogged = document.getElementById("userLogged");
          const userNameDisplay = document.getElementById("userNameDisplay");
          if (logged) {
            userNot.style.display = "none";
            userLogged.style.display = "block";
            userNameDisplay.textContent = logged.displayName || logged.username;
          } else {
            userNot.style.display = "block";
            userLogged.style.display = "none";
          }
        } catch (err) {}
      }
      loadUser();
    </script>
  </body>
</html>