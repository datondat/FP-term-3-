<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>FP - Trang chủ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner" style="align-items:center;">
      <div style="display:flex;align-items:center;gap:12px;">
        <a href="/" class="logo">FP</a>
        <div class="site-sub">Hệ thống học tập</div>
      </div>

      <div class="header-search">
        <input id="global-search" type="search" placeholder="Tìm môn hoặc tài liệu (nhấn Enter)" />
      </div>

      <!-- auth area left unchanged -->
      <div id="auth-area" style="margin-left:auto; display:flex; align-items:center; gap:8px;">
        <a id="link-register" class="nav-link" href="register.html">Đăng ký</a>
        <a id="link-login" class="nav-link" href="login.html">Đăng nhập</a>
        <a id="link-logout" class="nav-link" href="#" style="display:none">Đăng xuất</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div><h3 style="margin:0">Danh sách khối</h3></div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="back-all" class="btn-ghost" title="Quay lại">Quay lại</button>
        </div>
      </div>

      <div id="grades-area" class="cards-grid grades-wrapper" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
        <div class="grade-panel" data-grade="6">
          <div class="grade-title">Lớp 6</div>
          <ul id="grade-6" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="7">
          <div class="grade-title">Lớp 7</div>
          <ul id="grade-7" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="8">
          <div class="grade-title">Lớp 8</div>
          <ul id="grade-8" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="9">
          <div class="grade-title">Lớp 9</div>
          <ul id="grade-9" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="10">
          <div class="grade-title">Lớp 10</div>
          <ul id="grade-10" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="11">
          <div class="grade-title">Lớp 11</div>
          <ul id="grade-11" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="12">
          <div class="grade-title">Lớp 12</div>
          <ul id="grade-12" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="common">
          <div class="grade-title">Chung</div>
          <ul id="grade-common" class="subject-grid subject-list"></ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Hidden archive container to store moved long raw lists (keeps data but hidden) -->
  <div id="archived-raw-lists" aria-hidden="true" style="display:none"></div>

  <footer class="site-footer">
    <div class="container"><small>© FP — Hệ thống học tập</small></div>
  </footer>

<script>window.API_BASE = window.API_BASE || 'http://localhost:5001';</script>
<script src="subject-links.js"></script>

<!-- Permanent UI fix: keep short-links and blue buttons, move long raw lists into hidden archive -->
<script>
(function(){
  const FILE_EXT_RE = /\.(pdf|docx?|pptx?|xlsx?|xls)$/i;
  const ALLOW_DOMAIN_RE = /hoc10|hoc10vn|hoc10\.vn/i;

  function anchorsIn(node){
    return node ? Array.from(node.querySelectorAll('a')).filter(a => (a.textContent||'').trim().length) : [];
  }

  function isAllowedAnchor(a){
    try{
      const href = (a.getAttribute('href')||'').trim();
      const txt = (a.textContent||'').trim();
      if(ALLOW_DOMAIN_RE.test(href) || ALLOW_DOMAIN_RE.test(txt)) return true;
      if(FILE_EXT_RE.test(href)) return true;
      if(href.includes('/file.html')) return true;
      return false;
    }catch(e){ return false; }
  }

  function findShortLinksContainer(panel){
    const candidates = Array.from(panel.querySelectorAll('div, p, ul, ol, section'));
    for(const node of candidates){
      const aEls = anchorsIn(node);
      const count = aEls.length;
      if(count >=1 && count <= 8){
        let total = 0;
        aEls.forEach(a => total += (a.textContent||'').trim().length);
        const avg = count ? total / count : 0;
        if(avg <= 120) return node;
      }
    }
    return null;
  }

  function collectAllowedAnchors(panel){
    // collect anchors that should appear as blue buttons:
    // 1) anchors inside short-links container
    // 2) anchors matching allowed domain/file pattern anywhere in panel
    const short = findShortLinksContainer(panel);
    const ordered = [];
    if(short){
      anchorsIn(short).forEach(a => { if(isAllowedAnchor(a)) ordered.push({href:a.getAttribute('href'), label:(a.textContent||'').trim()}); });
    }
    anchorsIn(panel).forEach(a => {
      if(isAllowedAnchor(a) && !ordered.some(o => o.href === a.getAttribute('href') && o.label === (a.textContent||'').trim())) {
        ordered.push({href: a.getAttribute('href'), label: (a.textContent||'').trim()});
      }
    });
    return ordered;
  }

  function buildBlueGrid(panel, items){
    const old = panel.querySelector('.file-grid');
    if(old) old.remove();
    if(!items || !items.length) return null;

    const grid = document.createElement('div');
    grid.className = 'file-grid';

    items.forEach(it=>{
      const item = document.createElement('div');
      item.className = 'file-grid-item';
      const a = document.createElement('a');
      a.className = 'btn-file';
      a.href = it.href || ('/file.html?name=' + encodeURIComponent(it.label || ''));
      a.textContent = (it.label || '').length > 60 ? (it.label || '').slice(0,57) + '...' : (it.label || '');
      a.title = it.label || '';
      item.appendChild(a);
      grid.appendChild(item);
    });

    const short = findShortLinksContainer(panel);
    if(short) short.insertAdjacentElement('afterend', grid);
    else panel.appendChild(grid);

    return grid;
  }

  function moveLongListsToArchive(panel){
    const short = findShortLinksContainer(panel);
    const archive = document.getElementById('archived-raw-lists');
    if(!archive) return;
    // find candidate containers with many anchors (>=7)
    const nodes = Array.from(panel.querySelectorAll('div, p, ul, ol, section, li'));
    nodes.forEach(node => {
      if(!node) return;
      if(node === short) return;
      if(node.classList && (node.classList.contains('file-grid') || node.classList.contains('subject-list'))) return;
      try{
        const aCount = anchorsIn(node).length;
        if(aCount >= 7){
          // move node into archive (keeps data, removes from visual DOM)
          archive.appendChild(node);
          node.dataset.archived = '1';
        }
      }catch(e){}
    });
  }

  // Permanently remove header filter controls if present
  function removeHeaderFiltersPermanently(){
    const header = document.querySelector('.header-inner');
    if(!header) return;
    header.querySelectorAll('select, button, [role="button"]').forEach(el=>{
      try{
        const txt = ((el.getAttribute('aria-label')||'') + ' ' + (el.getAttribute('title')||'') + ' ' + (el.textContent||'')).trim();
        if(/Khối|Môn|Lọc/i.test(txt) || el.tagName === 'SELECT') el.remove();
      }catch(e){}
    });
    header.querySelectorAll('.filter-controls, .filter-group, .header-filter').forEach(e=>e.remove());
  }

  // Panel open behavior: create blue buttons based on allowed anchors and archive long lists
  document.addEventListener('click', function(ev){
    const panel = ev.target.closest('.grade-panel');
    if(!panel) return;
    if(ev.target && (ev.target.tagName === 'A' || ev.target.closest('a'))) return;

    // open UI
    document.querySelectorAll('.grade-panel').forEach(p => { if(p !== panel) p.classList.add('hidden'); });
    panel.classList.add('grade-selected');
    const ul = panel.querySelector('.subject-list'); if(ul) ul.classList.add('show-subjects');

    // collect anchors BEFORE moving nodes to archive
    const items = collectAllowedAnchors(panel);

    // move long raw lists out of panel (permanent hide from UI but stored in #archived-raw-lists)
    moveLongListsToArchive(panel);

    // build blue grid using collected items
    buildBlueGrid(panel, items);

    panel.scrollIntoView({behavior:'smooth', block:'start'});
  }, true);

  // Back-all: remove grids and restore panel visibility (archived nodes remain in hidden archive)
  const backAll = document.getElementById('back-all');
  if(backAll) backAll.addEventListener('click', function(ev){
    ev.preventDefault();
    // remove any file-grid clones
    document.querySelectorAll('.file-grid').forEach(g => g.remove());
    // show all panels
    document.querySelectorAll('.grade-panel').forEach(p => p.classList.remove('hidden','grade-selected'));
    document.querySelectorAll('.subject-list').forEach(ul => ul.classList.remove('show-subjects'));
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // Run permanent header filter cleanup now and on mutations (in case injected)
  function initPermanent(){
    removeHeaderFiltersPermanently();
  }
  initPermanent();
  const mo = new MutationObserver(()=>{ clearTimeout(window.__permDeb); window.__permDeb = setTimeout(initPermanent, 80); });
  mo.observe(document.body, { childList:true, subtree:true });

})();
</script>
</body>
</html>