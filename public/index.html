<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>FP - Trang chủ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner" style="align-items:center;">
      <div style="display:flex;align-items:center;gap:12px;">
        <a href="/" class="logo">FP</a>
        <div class="site-sub">Hệ thống học tập</div>
      </div>

      <div class="header-search">
        <input id="global-search" type="search" placeholder="Tìm môn hoặc tài liệu (nhấn Enter)" />
      </div>

      <!-- auth area unchanged -->
      <div id="auth-area" style="margin-left:auto; display:flex; align-items:center; gap:8px;">
        <a id="link-register" class="nav-link" href="register.html">Đăng ký</a>
        <a id="link-login" class="nav-link" href="login.html">Đăng nhập</a>
        <a id="link-logout" class="nav-link" href="#" style="display:none">Đăng xuất</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div><h3 style="margin:0">Danh sách khối</h3></div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="back-all" class="btn-ghost" title="Quay lại">Quay lại</button>
        </div>
      </div>

      <div id="grades-area" class="cards-grid grades-wrapper" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
        <div class="grade-panel" data-grade="6">
          <div class="grade-title">Lớp 6</div>
          <ul id="grade-6" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="7">
          <div class="grade-title">Lớp 7</div>
          <ul id="grade-7" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="8">
          <div class="grade-title">Lớp 8</div>
          <ul id="grade-8" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="9">
          <div class="grade-title">Lớp 9</div>
          <ul id="grade-9" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="10">
          <div class="grade-title">Lớp 10</div>
          <ul id="grade-10" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="11">
          <div class="grade-title">Lớp 11</div>
          <ul id="grade-11" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="12">
          <div class="grade-title">Lớp 12</div>
          <ul id="grade-12" class="subject-grid subject-list"></ul>
        </div>

        <div class="grade-panel" data-grade="common">
          <div class="grade-title">Chung</div>
          <ul id="grade-common" class="subject-grid subject-list"></ul>
        </div>
      </div>
    </section>
  </main>

  <div id="archived-raw-lists" aria-hidden="true" style="display:none"></div>

  <footer class="site-footer">
    <div class="container"><small>© FP — Hệ thống học tập</small></div>
  </footer>

<script>window.API_BASE = window.API_BASE || 'http://localhost:5001';</script>
<script src="subject-links.js"></script>

<!-- Fix script: remove header filters, keep pill buttons inside panels, restore UI panel click behavior -->
<script>
(function(){
  const FILE_EXT_RE = /\.(pdf|docx?|pptx?|xlsx?|xls)$/i;
  const HOC10_RE = /hoc10|hoc10vn|hoc10\.vn/i;
  const ARCHIVE_ID = 'archived-raw-lists';

  function textOf(n){ return (n && n.textContent) ? n.textContent.trim() : ''; }
  function anchorsIn(node){ return node ? Array.from(node.querySelectorAll('a')).filter(a => textOf(a)) : []; }
  function isAllowed(a){
    try{
      const href = (a.getAttribute('href')||'').trim();
      const txt = textOf(a);
      if(HOC10_RE.test(href) || HOC10_RE.test(txt)) return true;
      if(FILE_EXT_RE.test(href)) return true;
      if(href.includes('/file.html')) return true;
      return false;
    }catch(e){ return false; }
  }

  // -------- header filter removal --------
  function removeHeaderFilters(){
    const header = document.querySelector('.header-inner');
    if(!header) return;
    header.querySelectorAll('select, button, [role="button"]').forEach(el=>{
      try{
        const txt = (el.getAttribute('aria-label')||'') + ' ' + (el.getAttribute('title')||'') + ' ' + (el.textContent||'');
        if(/Khối|Môn|Lọc/i.test(txt) || el.tagName === 'SELECT') el.remove();
      }catch(e){}
    });
    // remove known classes too
    header.querySelectorAll('.filter-controls, .filter-group, .header-filter').forEach(e=>e.remove());
  }

  // ensure header filters are removed now and whenever DOM changes
  const headerObserver = new MutationObserver(()=>{ clearTimeout(window.__hdrDeb); window.__hdrDeb = setTimeout(removeHeaderFilters, 100); });
  headerObserver.observe(document.body, { childList:true, subtree:true });
  removeHeaderFilters();

  // -------- find short-links container inside a panel (immediately after .grade-title) --------
  function findShortLinksInPanel(panel){
    const title = panel.querySelector('.grade-title');
    if(title){
      let el = title.nextElementSibling;
      let tries = 0;
      while(el && tries < 8){
        if(anchorsIn(el).length > 0) return el;
        el = el.nextElementSibling; tries++;
      }
    }
    // fallback: any node inside panel with 1..8 anchors and short avg length
    const nodes = Array.from(panel.querySelectorAll('div,p,ul,ol,section'));
    for(const n of nodes){
      const aEls = anchorsIn(n);
      if(aEls.length >=1 && aEls.length <=8){
        const avg = aEls.reduce((s,a)=>s + textOf(a).length, 0) / aEls.length;
        if(avg <= 120) return n;
      }
    }
    return null;
  }

  // -------- build pill buttons inside panel (clone-only) --------
  function buildPillsForPanel(panel){
    // remove existing pills for idempotency
    const existing = panel.querySelector('.file-grid-pill');
    if(existing) existing.remove();

    const short = findShortLinksInPanel(panel);
    if(!short) return;

    // collect allowed anchors: first from short, then others in panel
    const collected = [];
    anchorsIn(short).forEach(a => { if(isAllowed(a)) collected.push(a); });
    anchorsIn(panel).forEach(a => { if(isAllowed(a) && !collected.includes(a)) collected.push(a); });

    if(collected.length === 0) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'file-grid-pill';
    wrapper.style.display='flex';
    wrapper.style.flexWrap='wrap';
    wrapper.style.gap='10px';
    wrapper.style.marginTop='12px';

    collected.forEach(a => {
      const clone = a.cloneNode(true);
      const label = textOf(clone) || (clone.getAttribute('href')||'');
      if(label.length > 50) clone.textContent = label.slice(0,47) + '...';
      clone.classList.add('btn-file');
      // minimal inline fallback styling (CSS provides main look)
      clone.style.padding='6px 12px';
      clone.style.borderRadius='999px';
      clone.style.border='1px solid rgba(11,121,208,0.12)';
      clone.style.background='var(--primary, #0b79d0)';
      clone.style.color='#fff';
      clone.style.fontWeight='700';
      clone.style.textDecoration='none';
      wrapper.appendChild(clone);
    });

    short.insertAdjacentElement('afterend', wrapper);
  }

  // -------- archive/move long raw lists (only inside panel, after short-links) --------
  function archiveLongLists(panel){
    const archive = document.getElementById(ARCHIVE_ID);
    if(!archive) return;
    const short = findShortLinksInPanel(panel);
    if(!short) return;
    let el = short.nextElementSibling;
    while(el){
      // stop if reach subject-list or pill wrapper
      if(el.classList && (el.classList.contains('subject-list') || el.classList.contains('file-grid-pill') || el.classList.contains('subject-inline-detail'))) break;
      try{
        const aCount = anchorsIn(el).length;
        if(aCount >= 5){
          archive.appendChild(el);
          // reset el to the next sibling of short (because we removed current)
          el = short.nextElementSibling;
          continue;
        }
      }catch(e){}
      el = el.nextElementSibling;
    }
  }

  function processPanel(panel){
    buildPillsForPanel(panel);
    archiveLongLists(panel);
  }

  // Run on single panel when it becomes selected
  function onOpenPanel(panel){
    processPanel(panel);
  }

  // -------- Recreate panel open/close behavior (minimal, safe) --------
  function initPanelUI(){
    const panels = Array.from(document.querySelectorAll('.grade-panel'));
    panels.forEach(panel=>{
      // Prevent multiple binding
      if(panel.dataset.uiBound === '1') return;
      panel.dataset.uiBound = '1';

      panel.addEventListener('click', function(ev){
        // if clicked a link, let link behavior happen
        if(ev.target && (ev.target.tagName === 'A' || ev.target.closest('a'))) return;
        // open this panel
        panels.forEach(p => { if(p !== panel) p.classList.add('hidden'); });
        panel.classList.add('grade-selected');
        const ul = panel.querySelector('.subject-list');
        if(ul) ul.classList.add('show-subjects');
        // build pills & archive inside this panel
        onOpenPanel(panel);
        panel.scrollIntoView({behavior:'smooth', block:'start'});
      }, false);
    });
  }

  // Back-all / logo restore behavior
  function initBackAndLogo(){
    const backAll = document.getElementById('back-all');
    const panels = Array.from(document.querySelectorAll('.grade-panel'));
    if(backAll && !backAll.dataset.bound){
      backAll.addEventListener('click', function(ev){
        ev.preventDefault();
        // remove pill wrappers (we only created clones)
        document.querySelectorAll('.file-grid-pill').forEach(g => g.remove());
        // show panels
        panels.forEach(p => p.classList.remove('hidden','grade-selected'));
        document.querySelectorAll('.subject-list').forEach(ul => ul.classList.remove('show-subjects'));
        window.scrollTo({top:0,behavior:'smooth'});
      });
      backAll.dataset.bound = '1';
    }

    const logo = document.querySelector('.logo');
    if(logo && !logo.dataset.bound){
      logo.addEventListener('click', function(){
        document.querySelectorAll('.file-grid-pill').forEach(g => g.remove());
        panels.forEach(p => p.classList.remove('hidden','grade-selected'));
        document.querySelectorAll('.subject-list').forEach(ul => ul.classList.remove('show-subjects'));
        window.scrollTo({top:0,behavior:'smooth'});
      });
      logo.dataset.bound = '1';
    }
  }

  // initialize UI and observers
  function init(){
    initPanelUI();
    initBackAndLogo();
    // run process for any panels already visible initially
    document.querySelectorAll('.grade-panel').forEach(p => { /* no auto archive until clicked */ });

    // Observe for new panels/DOM changes (subject-links.js injection) to re-bind UI and remove header filters
    const mo = new MutationObserver(()=>{ 
      clearTimeout(window.__uiDeb);
      window.__uiDeb = setTimeout(()=>{ removeHeaderFilters(); initPanelUI(); initBackAndLogo(); }, 120);
    });
    mo.observe(document.body, { childList:true, subtree:true });

    // initial removal of header filters (in case injected earlier)
    removeHeaderFilters();
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  // Expose debug helpers
  window.__fp_ui = { processPanel, archivedCount: ()=> document.getElementById(ARCHIVE_ID)?.children.length || 0 };
})();
</script>
</body>
</html>