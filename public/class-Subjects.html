<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Quản lý môn của lớp</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:720px;margin:20px auto;padding:16px}
    .subject{display:flex;align-items:center;margin:8px 0}
    .subject input{margin-right:12px}
    h2{margin-top:0}
  </style>
</head>
<body>
  <h2>Chọn môn cho lớp</h2>
  <div>
    <label>Lớp ID: <input id="classId" type="number" value="1" style="width:80px"></label>
    <button id="load">Tải môn</button>
  </div>
  <form id="form" style="margin-top:12px">
    <div id="list"></div>
    <div style="margin-top:12px">
      <button type="submit">Lưu thay đổi</button>
    </div>
  </form>
  <pre id="msg"></pre>

<script>
async function loadSubjects(classId) {
  const res = await fetch('/api/classes/' + classId + '/subjects');
  const j = await res.json();
  if (!j.ok) {
    document.getElementById('msg').textContent = 'Lỗi: ' + (j.error || 'unknown');
    return;
  }
  const list = document.getElementById('list');
  list.innerHTML = '';
  j.subjects.forEach(s => {
    const div = document.createElement('div');
    div.className = 'subject';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.name = 'subject';
    cb.value = s.id;
    if (s.assigned) cb.checked = true;
    const lbl = document.createElement('label');
    lbl.textContent = s.title;
    div.appendChild(cb);
    div.appendChild(lbl);
    list.appendChild(div);
  });
  document.getElementById('msg').textContent = 'Loaded ' + j.subjects.length + ' subjects';
}

document.getElementById('load').addEventListener('click', (e) => {
  const id = document.getElementById('classId').value;
  loadSubjects(id);
});

document.getElementById('form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('classId').value;
  const boxes = Array.from(document.querySelectorAll('#list input[name=subject]'));
  const selected = boxes.filter(b => b.checked).map(b => parseInt(b.value,10));
  const res = await fetch('/api/classes/' + id + '/subjects', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ subject_ids: selected }),
    credentials: 'include'
  });
  const j = await res.json();
  document.getElementById('msg').textContent = j.ok ? 'Lưu thành công' : ('Lỗi: ' + (j.error || 'unknown'));
});
</script>
</body>
</html>