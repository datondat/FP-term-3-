<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>FP — Tài liệu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="main.css">
  <style>
    /* Override inline styles with pastel theme colors */
    
    /* Viewer container */
    .viewer { 
      width:100%; 
      height:75vh; 
      border-radius:var(--radius, 12px);
      overflow:hidden; 
      background:#fefefe;
      border:2px solid #e3f2fd;
      margin-top:16px;
      box-shadow:0 10px 30px rgba(121,134,203,0.06);
      transition: all 350ms ease;
    }
    .viewer:hover{
      box-shadow: 0 15px 40px rgba(121,134,203,0.12);
      border-color: rgba(121,134,203,0.2);
    }
    
    .viewer .placeholder { 
      padding:24px;
      color:#78909c;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,250,252,0.98));
    }

    /* Controls */
    .controls { 
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Buttons with pastel gradient */
    .btn { 
      padding:10px 16px;
      border-radius:10px;
      background: linear-gradient(135deg, #7986cb 0%, #f48fb1 100%) !important;
      background-size: 200% 200%;
      color:#fff !important;
      text-decoration:none;
      display:inline-block;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition: all 350ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(121,134,203,0.25);
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 500ms ease, height 500ms ease;
      pointer-events: none;
    }
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(121,134,203,0.3), 0 0 15px rgba(244,143,177,0.15);
      background-position: 100% 0;
    }
    .btn:active{
      transform: translateY(0);
    }

    .btn-ghost { 
      padding:10px 16px;
      border-radius:10px;
      background:transparent !important;
      border:2px solid rgba(121,134,203,0.2) !important;
      color:#37474f !important;
      text-decoration:none;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      display:inline-block;
      transition: all 350ms ease;
      position: relative;
      overflow: hidden;
    }
    .btn-ghost::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(121,134,203,0.1);
      transform: translate(-50%, -50%);
      transition: all 500ms ease;
      pointer-events: none;
    }
    .btn-ghost:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn-ghost:hover{
      background: rgba(121,134,203,0.08) !important;
      border-color: #7986cb !important;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(121,134,203,0.15);
    }

    /* File header */
    #file-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      flex-wrap: wrap;
    }

    #file-title {
      margin:0;
      font-size:24px;
      font-weight:700;
      color:#37474f;
      background: linear-gradient(135deg, #7986cb 0%, #f48fb1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #file-meta {
      font-size:13px;
      color:#78909c;
      font-weight:500;
      margin-top:4px;
    }

    .muted { 
      color:#78909c !important;
      font-weight:500;
    }

    /* Comments section */
    #comments-list {
      margin-bottom:16px;
      max-height:420px;
      overflow-y:auto;
      padding:12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(248,250,252,0.5));
      border-radius:8px;
      border:1px solid #e3f2fd;
    }

    #comments-list::-webkit-scrollbar {
      width: 8px;
    }
    #comments-list::-webkit-scrollbar-track {
      background: rgba(121,134,203,0.05);
      border-radius: 4px;
    }
    #comments-list::-webkit-scrollbar-thumb {
      background: rgba(121,134,203,0.2);
      border-radius: 4px;
    }
    #comments-list::-webkit-scrollbar-thumb:hover {
      background: rgba(121,134,203,0.3);
    }

    /* Comment item styling */
    .comment-item {
      padding:12px;
      margin-bottom:10px;
      background:#fefefe;
      border-radius:8px;
      border:1px solid #e3f2fd;
      transition: all 200ms ease;
    }
    .comment-item:hover {
      box-shadow: 0 4px 12px rgba(121,134,203,0.08);
      transform: translateX(2px);
    }
    .comment-author {
      font-weight:700;
      color:#7986cb;
      font-size:14px;
    }
    .comment-date {
      font-size:12px;
      color:#78909c;
      margin-left:8px;
    }
    .comment-text {
      margin-top:6px;
      color:#37474f;
      line-height:1.6;
      font-size:14px;
    }

    /* Form inputs */
    #comment-author,
    #comment-text,
    input[type="text"],
    textarea {
      padding:12px;
      border:2px solid rgba(121,134,203,0.15) !important;
      border-radius:8px;
      background:#fff !important;
      font-size:14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      transition: all 200ms ease;
      width: 100%;
    }
    #comment-author:focus,
    #comment-text:focus,
    input[type="text"]:focus,
    textarea:focus {
      outline:none;
      border-color:#7986cb !important;
      box-shadow: 0 4px 15px rgba(121,134,203,0.15);
    }
    #comment-author::placeholder,
    #comment-text::placeholder,
    input[type="text"]::placeholder,
    textarea::placeholder {
      color:#78909c;
      font-weight:500;
    }

    /* Comment form wrapper */
    .comment-form-wrapper {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .comment-form-actions {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Nav styling */
    .nav-link { 
      margin-left:12px;
      padding:8px 14px;
      border-radius:8px;
      font-weight:600;
      font-size:14px;
      transition: all 200ms ease;
      white-space:nowrap;
      text-decoration:none;
      color:#37474f !important;
    }
    .nav-link:hover{
      background: rgba(121,134,203,0.1);
      transform: translateY(-1px);
    }

    .user-name { 
      margin-right:12px;
      font-weight:700;
      background: linear-gradient(135deg, #7986cb 0%, #f48fb1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-buttons { 
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* Section headers */
    .card h3 {
      font-size:18px;
      font-weight:700;
      color:#37474f;
      margin:0 0 12px 0;
      background: linear-gradient(135deg, #7986cb 0%, #f48fb1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Responsive adjustments */
    @media (max-width:800px){
      .controls{
        flex-direction:column;
        align-items:stretch;
      }
      .controls > * {
        width: 100%;
        text-align: center;
      }
      #file-header {
        flex-direction:column;
      }
      .viewer {
        height:60vh;
      }
      #comments-list {
        max-height:300px;
      }
    }

    @media (max-width:600px){
      #file-title {
        font-size:20px;
      }
      .btn, .btn-ghost {
        padding:8px 12px;
        font-size:13px;
      }
      #comment-author,
      #comment-text,
      input[type="text"],
      textarea {
        padding:10px;
        font-size:13px;
      }
    }

    /* Loading/empty states */
    .empty-state {
      text-align:center;
      padding:24px;
      color:#78909c;
      font-style:italic;
    }

    /* Accessibility */
    .btn:focus, 
    .btn-ghost:focus,
    input:focus,
    textarea:focus {
      outline: 3px solid rgba(121,134,203,0.3);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner" style="display:flex;align-items:center;gap:12px;">
      <div class="branding" style="display:flex;flex-direction:column;">
        <a href="/" class="logo">FP</a>
        <div class="site-sub">Hệ thống học tập</div>
      </div>

      <!-- Nav area. We keep the classic links but JS will add ?next=... and replace links with username+logout when logged in -->
      <nav class="site-nav" id="nav" style="margin-left:auto">
        <div class="nav-buttons" id="nav-buttons">
          <a href="register.html" id="link-register" class="nav-link">Đăng ký</a>
          <a href="login.html" id="link-login" class="nav-link">Đăng nhập</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div id="file-header">
        <div>
          <h2 id="file-title">Tài liệu</h2>
          <div id="file-meta" class="muted"></div>
        </div>
        <div class="controls">
          <a id="download-link" class="btn-ghost" rel="noopener" download>Tải về</a>
        </div>
      </div>

      <!-- Viewer placeholder: script will replace its contents -->
      <div id="viewer-wrapper" class="viewer">
        <div id="viewer-placeholder" class="placeholder">Chuẩn bị trình xem tài liệu...</div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3>Bình luận</h3>
      <div id="comments-list"></div>
      <div class="comment-form-wrapper">
        <input id="comment-author" type="text" placeholder="Tên (tuỳ chọn)">
        <textarea id="comment-text" placeholder="Viết bình luận..." rows="4"></textarea>
        <div class="comment-form-actions">
          <button id="comment-post" class="btn">Gửi bình luận</button>
          <button id="comment-clear" class="btn-ghost">Xoá</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>© FP — Hệ thống học tập</small>
    </div>
  </footer>

  <!-- Minimal inline script to ensure login link includes ?next and to render username/logout quickly.
       The bulk of viewer + comment logic is handled by public/file-viewer.js (keeps separation). -->
  <script>
    (function(){
      // Add ?next=currentPage to login/register links (so server redirects back after login).
      function qs(name){ try { return (new URL(window.location.href)).searchParams.get(name); } catch(e){ return null; } }
      function ensureAuthLinks() {
        try {
          const next = window.location.pathname + window.location.search + window.location.hash;
          const login = document.getElementById('link-login');
          if (login) {
            try {
              const u = new URL(login.getAttribute('href') || login.href, location.origin);
              u.searchParams.set('next', next);
              login.href = u.toString();
            } catch(e){ /* ignore */ }
          }
          const reg = document.getElementById('link-register');
          if (reg) {
            try {
              const u2 = new URL(reg.getAttribute('href') || reg.href, location.origin);
              u2.searchParams.set('next', next);
              reg.href = u2.toString();
            } catch(e){ /* ignore */ }
          }
        } catch(e){}
      }

      // Quick check current session and replace nav links with username + logout (lightweight).
      async function renderUserInNav() {
        try {
          // send cookie; fetch will include credentials only if same-origin and browser allowed cookies
          const res = await fetch('/api/me', { method: 'GET', credentials: 'include' });
          const j = await res.json().catch(()=>null);
          const nav = document.getElementById('nav');
          if (!nav) return;
          if (res.ok && j && j.ok && j.user) {
            // show username + logout
            const container = document.getElementById('nav-buttons');
            if (!container) return;
            container.innerHTML = '';
            const span = document.createElement('span');
            span.className = 'user-name';
            span.textContent = j.user.displayName || j.user.username || 'Người dùng';
            container.appendChild(span);
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = 'Đăng xuất';
            btn.addEventListener('click', async () => {
              try {
                await fetch('/api/logout', { method: 'POST', credentials: 'include' });
              } catch(e){}
              window.location.reload();
            });
            container.appendChild(btn);
          } else {
            ensureAuthLinks();
          }
        } catch (e) {
          // on error, still ensure links have next
          ensureAuthLinks();
        }
      }

      // Run early to ensure nav updated quickly
      ensureAuthLinks();
      renderUserInNav();
    })();
  </script>

  <!-- main viewer + comments script -->
  <script src="file-viewer.js"></script>
</body>
</html>