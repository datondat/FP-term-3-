<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Drive Viewer (client-only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:Arial;margin:16px;background:#f7f7f7}
    .wrap{max-width:1000px;margin:0 auto}
    input{padding:8px;border-radius:6px;border:1px solid #ddd}
    button{padding:8px 12px;border-radius:6px;background:#2d7cff;color:#fff;border:0}
    .list{background:#fff;padding:12px;border-radius:8px;margin-top:12px}
    .file{padding:8px;border-bottom:1px solid #f0f0f0}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Drive Viewer — Client-only (Quick test)</h2>
    <div>
      <input id="apiKey" placeholder="Google API Key (test only)" style="width:360px"/>
      <input id="root" placeholder="Drive root folder id" style="width:360px"/>
      <input id="cls" placeholder="Lớp (6)" style="width:80px"/>
      <input id="sub" placeholder="Môn (Toán)" style="width:140px"/>
      <button id="btn">Tìm</button>
    </div>
    <div class="list" id="filesList">Chưa có</div>
    <div id="preview" style="margin-top:12px"></div>
  </div>

  <script>
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    async function apiListFiles(apiKey, q){
      const url = 'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(q) + '&fields=files(id,name,mimeType,webViewLink,thumbnailLink)&key=' + encodeURIComponent(apiKey) + '&pageSize=1000';
      const res = await fetch(url);
      if(!res.ok) throw new Error('Drive API error ' + res.status);
      return res.json();
    }

    document.getElementById('btn').addEventListener('click', async ()=>{
      const apiKey = document.getElementById('apiKey').value.trim();
      const root = document.getElementById('root').value.trim();
      const cls = document.getElementById('cls').value.trim();
      const sub = document.getElementById('sub').value.trim();
      if(!apiKey || !root){ alert('Nhập apiKey và root'); return; }
      const listEl = document.getElementById('filesList');
      listEl.innerHTML = 'Đang tìm...';
      try {
        // Try to find class folder
        if(cls){
          const candidates = [`Lớp ${cls}`, `Lop ${cls}`, `${cls}`];
          let classFolder = null;
          for(const cand of candidates){
            const q = `'${root}' in parents and mimeType = 'application/vnd.google-apps.folder' and name contains '${cand}' and trashed = false`;
            const r = await apiListFiles(apiKey, q);
            if(r.files && r.files.length) { classFolder = r.files[0]; break; }
          }
          if(classFolder && sub){
            const q2 = `'${classFolder.id}' in parents and mimeType = 'application/vnd.google-apps.folder' and name contains '${sub}' and trashed = false`;
            const r2 = await apiListFiles(apiKey, q2);
            if(r2.files && r2.files.length){
              const folderId = r2.files[0].id;
              const qfiles = `'${folderId}' in parents and trashed = false`;
              const rf = await apiListFiles(apiKey, qfiles);
              renderFiles(rf.files || []);
              return;
            }
          }
        }
        // fallback: try subject under root if provided
        if(sub){
          const q = `'${root}' in parents and mimeType = 'application/vnd.google-apps.folder' and name contains '${sub}' and trashed = false`;
          const r = await apiListFiles(apiKey, q);
          if(r.files && r.files.length){
            const folderId = r.files[0].id;
            const qfiles = `'${folderId}' in parents and trashed = false`;
            const rf = await apiListFiles(apiKey, qfiles);
            renderFiles(rf.files || []);
            return;
          }
        }
        // final: list files in root
        const rf = await apiListFiles(apiKey, `'${root}' in parents and trashed = false`);
        renderFiles(rf.files || []);
      } catch(err){
        listEl.innerHTML = '<div style="color:red">'+escapeHtml(String(err))+'</div>';
      }
    });

    function renderFiles(files){
      const listEl = document.getElementById('filesList');
      if(!files || files.length===0){ listEl.innerHTML = 'Không tìm thấy file.'; return; }
      listEl.innerHTML = '';
      files.forEach(f=>{
        const div = document.createElement('div'); div.className='file';
        div.innerHTML = `<strong>${escapeHtml(f.name)}</strong> <small>${escapeHtml(f.mimeType)}</small> <a href="${f.webViewLink||('https://drive.google.com/file/d/'+f.id+'/view')}" target="_blank">Mở</a>`;
        listEl.appendChild(div);
      });
    }
  </script>
</body>
</html>